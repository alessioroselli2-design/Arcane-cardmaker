<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Card Maker – finale</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Spectral:wght@400;600&family=Inter:wght@400;600&family=EB+Garamond:wght@400;600&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{--bg:#0f1115;--panel:#171a21;--stroke:#2a2f3a;--text:#eaeefb;--muted:#9aa4b2}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--stroke)}
  .wrap{display:grid;grid-template-columns:minmax(310px,380px) 1fr;gap:14px;padding:14px}
  aside{background:var(--panel);border:1px solid var(--stroke);border-radius:12px;padding:12px;max-height:calc(100dvh - 90px);overflow:auto}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  input,textarea,select{width:100%;background:#11141a;color:var(--text);border:1px solid var(--stroke);border-radius:10px;padding:10px;font-size:14px}
  input[type=color]{padding:6px;height:40px}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{padding:10px 12px;background:#12151b;color:var(--text);border:1px solid var(--stroke);border-radius:10px;cursor:pointer;font-weight:600}
  .btnbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .preview{background:#0b0f16;border:1px solid var(--stroke);border-radius:12px;display:grid;place-items:center;padding:14px;min-height:620px}
  canvas{width:420px;height:588px;border-radius:14px;background:#0d0f14}
  small.muted{color:var(--muted);display:block;margin-top:6px;line-height:1.3}
  .group{border-top:1px solid var(--stroke);margin-top:12px;padding-top:8px}
  /* Welcome */
  .welcome{position:fixed;inset:0;z-index:1000;background:#d9cfb2;display:flex;align-items:center;justify-content:center;padding:18px}
  .welcome-card{background:#171a21;color:#fff;border-radius:14px;padding:20px;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .welcome-actions{display:flex;align-items:center;gap:12px;margin-top:14px}
  .hide{display:none}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
</style>

<script>
function enterApp(){
  const w=document.getElementById('welcome');
  const cb=document.getElementById('dontShow');
  if(cb?.checked){ localStorage.setItem('cm_hide_welcome','true'); }
  w.classList.add('hide');
}
document.addEventListener('DOMContentLoaded',()=>{
  const params=new URLSearchParams(location.search);
  const force=params.get('welcome')==='1';
  if(!force && localStorage.getItem('cm_hide_welcome')==='true'){
    document.getElementById('welcome').classList.add('hide');
  }else{
    if(force) localStorage.removeItem('cm_hide_welcome');
  }
});
</script>
</head>
<body>
<!-- Welcome -->
<div id="welcome" class="welcome">
  <div class="welcome-card">
    <h2 style="margin:0 0 6px">Benvenuto in Card Maker</h2>
    <p>Crea carte in stile Magic: titolo, mana, simbolo classe (immagine), bordi, retro pieno e PDF 3×3.</p>
    <div class="welcome-actions">
      <label><input type="checkbox" id="dontShow"> Non mostrare più</label>
      <button class="btn" onclick="enterApp()">Entra nell’app</button>
    </div>
  </div>
</div>

<header><strong>Card Maker – finale</strong></header>

<div class="wrap">
  <aside>
    <!-- Titolo / Mana / Simbolo classe -->
    <div class="row">
      <div>
        <label>Titolo</label>
        <input id="title" placeholder="Nome incantesimo">
      </div>
      <div>
        <label>Mana (opzionale)</label>
        <input id="mana" placeholder="{G}{G}">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Font titolo</label>
        <select id="titleFont">
          <option value='"Cinzel",serif'>Cinzel</option>
          <option value='"Spectral",serif'>Spectral</option>
          <option value='Inter,sans-serif'>Inter</option>
          <option value='"EB Garamond",serif'>EB Garamond</option>
          <option value='"Merriweather",serif'>Merriweather</option>
          <option value='"Playfair Display",serif'>Playfair Display</option>
        </select>
        <label style="margin-top:6px">Carica font titolo (TTF/OTF)</label>
        <input id="titleFontFile" type="file" accept=".ttf,.otf">
      </div>
      <div>
        <label>Dimensione titolo</label>
        <input id="titleSize" type="range" min="26" max="56" value="44">
        <label style="margin-top:6px">Colore titolo</label>
        <input id="titleColor" type="color" value="#ffffff">
        <small class="muted">Preset: <a href="#" data-col="gold" class="preset">Oro</a> · <a href="#" data-col="silver" class="preset">Argento</a></small>
      </div>
    </div>

    <!-- Simbolo classe solo immagine -->
    <div class="row">
      <div>
        <label>Simbolo classe (PNG/SVG, opzionale)</label>
        <input id="classImg" type="file" accept="image/*">
      </div>
      <div>
        <label>Dimensione simbolo classe</label>
        <input id="classSize" type="range" min="24" max="120" value="48">
      </div>
    </div>

    <!-- Colori riquadri e cornice -->
    <div class="row">
      <div>
        <label>Colore linee/riquadri</label>
        <input id="panelColor" type="color" value="#cdbb7d">
      </div>
      <div>
        <label>Opacità riquadri</label>
        <input id="panelAlpha" type="range" min="0" max="100" value="85">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Colore cornice esterna (fronte+retro)</label>
        <input id="frameColor" type="color" value="#d8cfae">
      </div>
      <div>
        <label>Colore interno carta</label>
        <input id="innerColor" type="color" value="#f7f5ef">
      </div>
    </div>

    <!-- Immagini -->
    <div class="group">
      <label>Immagine fronte</label>
      <input id="artFront" type="file" accept="image/*">
      <label>Immagine retro (riempie tutta la cornice interna)</label>
      <input id="artBack" type="file" accept="image/*">
    </div>

    <!-- Descrizione -->
    <div class="group">
      <label>Descrizione (riquadro basso)</label>
      <textarea id="rulesText" placeholder="Testo/incantesimo…"></textarea>
      <div class="row">
        <div>
          <label>Font descrizione</label>
          <select id="descFont">
            <option value='"Spectral",serif'>Spectral</option>
            <option value='"Cinzel",serif'>Cinzel</option>
            <option value='Inter,sans-serif'>Inter</option>
            <option value='"EB Garamond",serif'>EB Garamond</option>
            <option value='"Merriweather",serif'>Merriweather</option>
            <option value='"Playfair Display",serif'>Playfair Display</option>
          </select>
          <label style="margin-top:6px">Carica font descrizione (TTF/OTF)</label>
          <input id="descFontFile" type="file" accept=".ttf,.otf">
        </div>
        <div>
          <label>Dimensione descrizione</label>
          <input id="descSize" type="range" min="14" max="26" value="18">
          <label style="margin-top:6px">Colore descrizione</label>
          <input id="descColor" type="color" value="#111111">
        </div>
      </div>
    </div>

    <!-- Export -->
    <div class="group btnbar">
      <button class="btn" id="pngFront">PNG (fronte)</button>
      <button class="btn" id="pngBack">PNG (retro)</button>
      <button class="btn" id="pdfSingleFront">PDF singola (fronte)</button>
      <button class="btn" id="pdfSingleBack">PDF singola (retro)</button>
      <button class="btn" id="pdfA4Front">PDF A4 3×3 (fronti)</button>
      <button class="btn" id="pdfA4Back">PDF A4 3×3 (retro)</button>
      <button class="btn" id="pdfA4Both">PDF A4 3×3 (fronte+retro)</button>
    </div>
    <small class="muted">Stampa: A4 verticale, margini minimi, scala 100% (no “adatta”). Carte ~63×88 mm.</small>
  </aside>

  <section class="preview">
    <canvas id="cardFront" width="750" height="1050" aria-label="Fronte"></canvas>
  </section>
</div>

<script>
/* --------- Stato --------- */
const state={
  title:'', mana:'',
  titleFont:'"Cinzel",serif', titleSize:44, titleColor:'#ffffff',
  descText:'', descFont:'"Spectral",serif', descSize:18, descColor:'#111111',
  panelColor:'#cdbb7d', panelAlpha:0.85,
  frameColor:'#d8cfae', innerColor:'#f7f5ef',
  classSize:48, imgClass:null,
  imgFront:null, imgBack:null,
  customTitleFontName:null, customDescFontName:null
};

/* --------- Utility --------- */
function loadImage(file, cb){ if(!file) return cb(null); const img=new Image(); img.onload=()=>cb(img); img.src=URL.createObjectURL(file); }
function rr(ctx,x,y,w,h,r){r=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function cover(ctx,img,dx,dy,dw,dh,r=0){
  const ir=img.width/img.height, dr=dw/dh; let sx,sy,sw,sh;
  if(ir>dr){ sh=img.height; sw=sh*dr; sx=(img.width-sw)/2; sy=0; }
  else{ sw=img.width; sh=sw/dr; sx=0; sy=(img.height-sh)/2; }
  if(r>0){ ctx.save(); rr(ctx,dx,dy,dw,dh,r); ctx.clip(); }
  ctx.drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh);
  if(r>0) ctx.restore();
}
function gold(ctx){const g=ctx.createLinearGradient(0,0,0,30);g.addColorStop(0,'#fff7b3');g.addColorStop(.5,'#d3b25b');g.addColorStop(1,'#7a6223');return g;}
function silver(ctx){const g=ctx.createLinearGradient(0,0,0,30);g.addColorStop(0,'#ffffff');g.addColorStop(.5,'#cfd6e6');g.addColorStop(1,'#7f8aa3');return g;}
function drawTextWrap(ctx,text,x,y,maxW,lh){const w=(text||'').split(/\s+/);let line='',yy=y;for(let i=0;i<w.length;i++){const t=line+w[i]+' ';if(ctx.measureText(t).width>maxW&&i>0){ctx.fillText(line,x,yy);line=w[i]+' ';yy+=lh}else line=t}ctx.fillText(line,x,yy);}

/* --------- Font caricabili --------- */
async function loadCustomFont(file, familyName){
  const blobUrl = URL.createObjectURL(file);
  const face = new FontFace(familyName, `url(${blobUrl})`);
  await face.load();
  document.fonts.add(face);
  return familyName;
}

/* --------- Disegno fronte --------- */
const front=document.getElementById('cardFront'); const fctx=front.getContext('2d');

function drawFront(){
  const W=750,H=1050; fctx.clearRect(0,0,W,H);

  // Cornice + interno con colori selezionati
  fctx.fillStyle=state.frameColor; rr(fctx,0,0,W,H,36); fctx.fill();
  fctx.fillStyle=state.innerColor; rr(fctx,16,16,W-32,H-32,24); fctx.fill();

  // Pannelli colorabili
  fctx.globalAlpha=state.panelAlpha;
  fctx.fillStyle=state.panelColor;
  rr(fctx,28,28,W-56,86,16); fctx.fill(); // barra titolo
  rr(fctx,28,610,W-56,412,18); fctx.fill(); // box descrizione
  fctx.globalAlpha=1;

  // Immagine centrale
  const ax=44, ay=132, aw=W-88, ah=460;
  if(state.imgFront) cover(fctx,state.imgFront,ax,ay,aw,ah,18);
  else { fctx.fillStyle='#cfcfcf'; rr(fctx,ax,ay,aw,ah,18); fctx.fill(); }

  // Titolo (a sinistra)
  const titleFamily = state.customTitleFontName ? `"${state.customTitleFontName}"` : state.titleFont;
  fctx.textBaseline='middle';
  fctx.font = `700 ${state.titleSize}px ${titleFamily}`;
  let tcol = (state.titleColor||'').toLowerCase();
  if(tcol==='gold') fctx.fillStyle=gold(fctx);
  else if(tcol==='silver') fctx.fillStyle=silver(fctx);
  else fctx.fillStyle=state.titleColor;
  fctx.fillText(state.title||'', 44, 71, 520);

  // Simbolo classe (se presente) in alto a destra
  let sXRight = W-44, symbolWidth = 0;
  if(state.imgClass){
    const s = state.classSize;
    const sy = 71 - s/2;
    cover(fctx, state.imgClass, sXRight - s, sy, s, s, 8);
    symbolWidth = s + 8; // 8px di gap dal mana
  }

  // Mana (opzionale) — se c'è il simbolo, si sposta verso il centro
  const mana=(state.mana||'').trim();
  if(mana){
    fctx.fillStyle='#222';
    fctx.font='600 22px Inter,sans-serif';
    fctx.textAlign='right';
    const manaRightEdge = sXRight - symbolWidth;   // se c'è simbolo, si sposta a sinistra
    const manaX = manaRightEdge;                   // allineato a destra sul nuovo bordo
    fctx.fillText(mana, manaX, 71);
    fctx.textAlign='left';
  }

  // Descrizione (riquadro basso)
  const descFamily = state.customDescFontName ? `"${state.customDescFontName}"` : state.descFont;
  const bx=40, by=618, bw=W-80, bh=396;
  fctx.save(); rr(fctx,bx,by,bw,bh,18); fctx.clip();
  fctx.fillStyle=state.descColor; fctx.font=`400 ${state.descSize}px ${descFamily}`;
  drawTextWrap(fctx, state.descText||'', bx+18, by+18, bw-36, state.descSize*1.45);
  fctx.restore();
}

/* --------- Retro --------- */
function drawBackCanvas(){
  const c=document.createElement('canvas'); c.width=750; c.height=1050; const ctx=c.getContext('2d');
  rr(ctx,0,0,750,1050,36); ctx.fillStyle=state.frameColor; ctx.fill();          // stessa cornice del fronte
  rr(ctx,16,16,750-32,1050-32,24); ctx.fillStyle=state.innerColor; ctx.fill();  // riempimento interno
  // immagine a piena cornice interna
  if(state.imgBack) cover(ctx,state.imgBack,16,16,750-32,1050-32,24);
  return c;
}

/* --------- Bind UI --------- */
const $=id=>document.getElementById(id);
$('title').oninput=e=>{state.title=e.target.value;drawFront();}
$('mana').oninput=e=>{state.mana=e.target.value;drawFront();}
$('titleFont').onchange=e=>{state.customTitleFontName=null;state.titleFont=e.target.value;drawFront();}
$('titleSize').oninput=e=>{state.titleSize=+e.target.value;drawFront();}
$('titleColor').oninput=e=>{state.titleColor=e.target.value;drawFront();}
document.querySelectorAll('.preset').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();state.titleColor=a.dataset.col;drawFront()}));

$('descFont').onchange=e=>{state.customDescFontName=null;state.descFont=e.target.value;drawFront();}
$('descSize').oninput=e=>{state.descSize=+e.target.value;drawFront();}
$('descColor').oninput=e=>{state.descColor=e.target.value;drawFront();}

$('panelColor').oninput=e=>{state.panelColor=e.target.value;drawFront();}
$('panelAlpha').oninput=e=>{state.panelAlpha=+e.target.value/100;drawFront();}

$('frameColor').oninput=e=>{state.frameColor=e.target.value;drawFront();}
$('innerColor').oninput=e=>{state.innerColor=e.target.value;drawFront();}

$('classSize').oninput=e=>{state.classSize=+e.target.value;drawFront();}
$('classImg').addEventListener('change',e=>{loadImage(e.target.files?.[0], img=>{state.imgClass=img;drawFront();});});

$('artFront').addEventListener('change',e=>{loadImage(e.target.files?.[0], img=>{state.imgFront=img;drawFront();});});
$('artBack').addEventListener('change',e=>{loadImage(e.target.files?.[0], img=>{state.imgBack=img;});});

$('titleFontFile').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fam='UserTitleFont'; await loadCustomFont(f,fam); state.customTitleFontName=fam; drawFront();
});
$('descFontFile').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fam='UserDescFont'; await loadCustomFont(f,fam); state.customDescFontName=fam; drawFront();
});

/* --------- Export --------- */
function downloadDataUrl(filename, dataUrl){ const a=document.createElement('a'); a.download=filename; a.href=dataUrl; a.click(); }
$('pngFront').onclick=()=>{ drawFront(); downloadDataUrl('carta-front.png', front.toDataURL('image/png')); };
$('pngBack').onclick=()=>{ const back=drawBackCanvas(); downloadDataUrl('carta-back.png', back.toDataURL('image/png')); };

$('pdfSingleFront').onclick=()=>exportSingle(front,'carta-front.pdf');
$('pdfSingleBack').onclick=()=>{ const back=drawBackCanvas(); exportSingle(back,'carta-back.pdf'); };

function exportSingle(canvasEl, name){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:[69,94]});
  const img=canvasEl.toDataURL('image/png'); doc.addImage(img,'PNG',0,0,69,94); doc.save(name);
}

$('pdfA4Front').onclick=()=>exportA4Grid(front,'carte_3x3_fronti.pdf');
$('pdfA4Back').onclick=()=>{ const back=drawBackCanvas(); exportA4Grid(back,'carte_3x3_retro.pdf'); };
$('pdfA4Both').onclick=()=>exportA4Both();

function exportA4Grid(canvasEl, name){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W=210,H=297,cw=63,ch=88,marginX=7,marginY=7,gapX=(W-3*cw-2*marginX)/2,gapY=(H-3*ch-2*marginY)/2;
  const img=canvasEl.toDataURL('image/png');
  for(let r=0;r<3;r++) for(let c=0;c<3;c++){
    const x=marginX + c*(cw+gapX), y=marginY + r*(ch+gapY);
    doc.addImage(img,'PNG',x,y,cw,ch,undefined,'FAST');
  }
  doc.save(name);
}
function exportA4Both(){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W=210,H=297,cw=63,ch=88,marginX=7,marginY=7,gapX=(W-3*cw-2*marginX)/2,gapY=(H-3*ch-2*marginY)/2;

  drawFront();
  let img=front.toDataURL('image/png');
  for(let r=0;r<3;r++) for(let c=0;c<3;c++){
    const x=marginX + c*(cw+gapX), y=marginY + r*(ch+gapY);
    doc.addImage(img,'PNG',x,y,cw,ch,undefined,'FAST');
  }
  doc.addPage('a4','portrait');
  const back=drawBackCanvas(); img=back.toDataURL('image/png');
  for(let r=0;r<3;r++) for(let c=0;c<3;c++){
    const x=marginX + c*(cw+gapX), y=marginY + r*(ch+gapY);
    doc.addImage(img,'PNG',x,y,cw,ch,undefined,'FAST');
  }
  doc.save('carte_3x3_fronte+retro.pdf');
}

/* init */
drawFront();
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
</script>
</body>
</html>
