<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Arcane CardMaker — v9 (DB + Fantasy + Drag)</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Spectral:wght@400;600&family=Inter:wght@400;600&family=EB+Garamond:wght@400;600&family=Merriweather:wght@400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{--bg:#0f1115;--panel:#171a21;--stroke:#2a2f3a;--text:#eaeefb;--muted:#9aa4b2}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  header{padding:14px 16px;border-bottom:1px solid var(--stroke)}
  .wrap{display:grid;grid-template-columns:minmax(310px,380px) 1fr;gap:14px;padding:14px}
  aside{background:#171a21;border:1px solid var(--stroke);border-radius:12px;padding:12px;max-height:calc(100dvh - 90px);overflow:auto}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
  input,textarea,select,button{font-family:inherit}
  input,textarea,select{width:100%;background:#11141a;color:var(--text);border:1px solid var(--stroke);border-radius:10px;padding:10px;font-size:14px}
  input[type=color]{padding:6px;height:40px}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{padding:10px 12px;background:#12151b;color:var(--text);border:1px solid var(--stroke);border-radius:10px;cursor:pointer;font-weight:600}
  .btnbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  .preview{background:#0b0f16;border:1px solid var(--stroke);border-radius:12px;display:grid;place-items:center;padding:14px;min-height:620px}
  canvas{width:420px;height:588px;border-radius:14px;background:#0d0f14}
  small.muted{color:var(--muted);display:block;margin-top:6px;line-height:1.3}
  .group{border-top:1px solid var(--stroke);margin-top:12px;padding-top:8px}
  /* Welcome */
  .welcome{position:fixed;inset:0;z-index:1000;background:#d9cfb2;display:flex;align-items:center;justify-content:center;padding:18px}
  .welcome-card{background:#171a21;color:#fff;border-radius:14px;padding:20px;max-width:520px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .welcome-actions{display:flex;align-items:center;gap:12px;margin-top:14px}
  .hide{display:none}
  @media (max-width:980px){.wrap{grid-template-columns:1fr}}
</style>

<script>
function enterApp(){
  const w=document.getElementById('welcome');
  const cb=document.getElementById('dontShow');
  if(cb?.checked){ localStorage.setItem('cm_hide_welcome','true'); }
  w.classList.add('hide');
}
document.addEventListener('DOMContentLoaded',()=>{
  const p=new URLSearchParams(location.search);
  const force=p.get('welcome')==='1';
  const flag=localStorage.getItem('cm_hide_welcome');
  if(force){ localStorage.removeItem('cm_hide_welcome'); document.getElementById('welcome').classList.remove('hide'); return; }
  if(flag==='true'){ document.getElementById('welcome').classList.add('hide'); }
});
</script>
</head>
<body>
<!-- Welcome -->
<div id="welcome" class="welcome">
  <div class="welcome-card">
    <h2 style="margin:0 0 6px">Benvenuto in Card Maker</h2>
    <p>Crea carte in stile Magic: titolo, mana, simbolo classe (database/immagine), retro pieno, PDF 3×3.</p>
    <div class="welcome-actions">
      <label><input type="checkbox" id="dontShow"> Non mostrare più</label>
      <button class="btn" onclick="enterApp()">Entra nell’app</button>
    </div>
  </div>
</div>

<header><strong>Arcane CardMaker — v9</strong></header>

<div class="wrap">
  <aside>
    <!-- Titolo / Mana -->
    <div class="row">
      <div>
        <label>Titolo</label>
        <input id="title" placeholder="Nome incantesimo">
      </div>
      <div>
        <label>Mana (opzionale)</label>
        <input id="mana" placeholder="{G}{G}">
      </div>
    </div>

    <!-- Font titolo -->
    <div class="row">
      <div>
        <label>Font titolo</label>
        <select id="titleFont">
          <option value='"Cinzel",serif'>Cinzel</option>
          <option value='"Spectral",serif'>Spectral</option>
          <option value='Inter,sans-serif'>Inter</option>
          <option value='"EB Garamond",serif'>EB Garamond</option>
          <option value='"Merriweather",serif'>Merriweather</option>
          <option value='"Playfair Display",serif'>Playfair Display</option>
        </select>
        <label style="margin-top:6px">Carica font titolo (TTF/OTF)</label>
        <input id="titleFontFile" type="file" accept=".ttf,.otf">
      </div>
      <div>
        <label>Dimensione titolo</label>
        <input id="titleSize" type="range" min="26" max="56" value="44">
        <label style="margin-top:6px">Colore titolo</label>
        <input id="titleColor" type="color" value="#ffffff">
        <small class="muted">Preset: <a href="#" data-col="gold" class="preset">Oro</a> · <a href="#" data-col="silver" class="preset">Argento</a></small>
      </div>
    </div>

    <!-- SIMBOLO CLASSE -->
    <div class="group">
      <div class="row">
        <div>
          <label>Sorgente simbolo classe</label>
          <select id="classSource">
            <option value="none">Nessuno</option>
            <option value="db" selected>Database</option>
            <option value="upload">Carica immagine</option>
          </select>
        </div>
        <div>
          <label>Dimensione simbolo</label>
          <input id="classSize" type="range" min="24" max="140" value="56">
        </div>
      </div>

      <div class="row" id="dbRow">
        <div>
          <label>Classe (database)</label>
          <select id="clazz">
            <optgroup label="Base">
              <option value="guerriero">Guerriero</option>
              <option value="druido">Druido</option>
              <option value="monaco">Monaco</option>
              <option value="mago">Mago</option>
              <option value="ladro">Ladro</option>
            </optgroup>
            <optgroup label="Espansione">
              <option value="barbaro">Barbaro</option>
              <option value="paladino">Paladino</option>
              <option value="chierico">Chierico</option>
              <option value="bardo">Bardo</option>
              <option value="ranger">Ranger</option>
              <option value="stregone">Stregone</option>
              <option value="warlock">Warlock</option>
              <option value="artificiere">Artificiere</option>
            </optgroup>
          </select>
        </div>
        <div>
          <label>Utility</label>
          <button class="btn" id="btnShowWelcome" type="button">Mostra schermata di benvenuto</button>
        </div>
      </div>

      <div id="uploadRow" style="display:none">
        <label>Carica simbolo (PNG/SVG)</label>
        <input id="classImg" type="file" accept="image/*">
      </div>
      <small class="muted">Trascina il simbolo direttamente sull’anteprima per spostarlo (drag & drop).</small>
    </div>

    <!-- Colori riquadri e cornice -->
    <div class="row">
      <div>
        <label>Colore linee/riquadri</label>
        <input id="panelColor" type="color" value="#cdbb7d">
      </div>
      <div>
        <label>Opacità riquadri</label>
        <input id="panelAlpha" type="range" min="0" max="100" value="85">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Colore cornice esterna (fronte+retro)</label>
        <input id="frameColor" type="color" value="#d8cfae">
      </div>
      <div>
        <label>Colore interno carta</label>
        <input id="innerColor" type="color" value="#f7f5ef">
      </div>
    </div>

    <!-- Immagini -->
    <div class="group">
      <label>Immagine fronte</label>
      <input id="artFront" type="file" accept="image/*">
      <label>Immagine retro (riempie tutta la cornice interna)</label>
      <input id="artBack" type="file" accept="image/*">
    </div>

    <!-- Descrizione -->
    <div class="group">
      <label>Descrizione (riquadro basso)</label>
      <textarea id="rulesText" placeholder="Testo/incantesimo…"></textarea>
      <div class="row">
        <div>
          <label>Font descrizione</label>
          <select id="descFont">
            <option value='"Spectral",serif'>Spectral</option>
            <option value='"Cinzel",serif'>Cinzel</option>
            <option value='Inter,sans-serif'>Inter</option>
            <option value='"EB Garamond",serif'>EB Garamond</option>
            <option value='"Merriweather",serif'>Merriweather</option>
            <option value='"Playfair Display",serif'>Playfair Display</option>
          </select>
          <label style="margin-top:6px">Carica font descrizione (TTF/OTF)</label>
          <input id="descFontFile" type="file" accept=".ttf,.otf">
        </div>
        <div>
          <label>Dimensione descrizione</label>
          <input id="descSize" type="range" min="14" max="26" value="18">
          <label style="margin-top:6px">Colore descrizione</label>
          <input id="descColor" type="color" value="#111111">
        </div>
      </div>
    </div>

    <!-- Export -->
    <div class="group btnbar">
      <button class="btn" id="pngFront">PNG (fronte)</button>
      <button class="btn" id="pngBack">PNG (retro)</button>
      <button class="btn" id="pdfSingleFront">PDF singola (fronte)</button>
      <button class="btn" id="pdfSingleBack">PDF singola (retro)</button>
      <button class="btn" id="pdfA4Front">PDF A4 3×3 (fronti)</button>
      <button class="btn" id="pdfA4Back">PDF A4 3×3 (retro)</button>
      <button class="btn" id="pdfA4Both">PDF A4 3×3 (fronte+retro)</button>
    </div>
    <small class="muted">Stampa: A4 verticale, margini minimi, scala 100% (no “adatta”). Carte ~63×88 mm.</small>
  </aside>

  <section class="preview">
    <canvas id="cardFront" width="750" height="1050" aria-label="Fronte"></canvas>
  </section>
</div>

<script>
/* --------- Stato --------- */
const state={
  title:'', mana:'',
  titleFont:'"Cinzel",serif', titleSize:44, titleColor:'#ffffff',
  descText:'', descFont:'"Spectral",serif', descSize:18, descColor:'#111111',
  panelColor:'#cdbb7d', panelAlpha:0.85,
  frameColor:'#d8cfae', innerColor:'#f7f5ef',
  classSize:56, classSource:'db', clazz:'guerriero',
  imgClass:null, classX:null, classY:null, // posizione drag
  imgFront:null, imgBack:null,
  customTitleFontName:null, customDescFontName:null
};

/* --------- Icone database (SVG “fantasy”) --------- */
const ICONS = {
  guerriero:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0' y1='0' x2='0' y2='1'><stop offset='0' stop-color='#fff'/><stop offset='1' stop-color='#c7c7c7'/></linearGradient></defs><path d='M50 10 l12 18 h18 l-15 12 6 20 -21-12 -21 12 6-20 -15-12 h18z' fill='url(#g)' stroke='#222' stroke-width='2'/><rect x='42' y='60' width='16' height='22' rx='4' fill='#fff' stroke='#222' stroke-width='2'/></svg>`,
  druido:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 10 C28 36,26 60,50 90 C74 60,72 36,50 10 Z' fill='#e9ffe0' stroke='#225522' stroke-width='2'/><path d='M50 36 C44 48,44 60,50 72 C56 60,56 48,50 36 Z' fill='#225522'/></svg>`,
  monaco:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='34' fill='#fff' stroke='#333' stroke-width='2'/><path d='M50 20 A30 30 0 1 1 20 50' stroke='#333' stroke-width='10' fill='none' stroke-linecap='round'/></svg>`,
  mago:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><polygon points='50,8 60,38 92,38 65,58 74,90 50,72 26,90 35,58 8,38 40,38' fill='#f0f0ff' stroke='#333' stroke-width='2'/></svg>`,
  ladro:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20 48 Q50 20,80 48 Q70 66,50 66 Q30 66,20 48 Z' fill='#fff' stroke='#222' stroke-width='2'/><circle cx='38' cy='54' r='6' fill='#222'/><circle cx='62' cy='54' r='6' fill='#222'/></svg>`,
  barbaro:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M25 20 l20 15 -20 15 z' fill='#eee' stroke='#222' stroke-width='2'/><path d='M75 20 l-20 15 20 15 z' fill='#eee' stroke='#222' stroke-width='2'/><rect x='47' y='18' width='6' height='64' fill='#c8a27a' stroke='#222' stroke-width='2'/></svg>`,
  paladino:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 10 L80 25 V55 C80 70,65 82,50 90 C35 82,20 70,20 55 V25 Z' fill='#fff' stroke='#333' stroke-width='2'/><path d='M50 22 V70' stroke='#333' stroke-width='6'/><path d='M35 45 H65' stroke='#333' stroke-width='6'/></svg>`,
  chierico:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='34' r='14' fill='#fff' stroke='#333' stroke-width='2'/><rect x='44' y='46' width='12' height='34' fill='#fff' stroke='#333' stroke-width='2'/><rect x='34' y='56' width='32' height='12' fill='#fff' stroke='#333' stroke-width='2'/></svg>`,
  bardo:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M28 20 C70 20,72 60,42 84' stroke='#fff' stroke-width='4' fill='none'/><circle cx='42' cy='84' r='6' fill='#fff'/><line x1='50' y1='26' x2='50' y2='78' stroke='#fff' stroke-width='2'/><line x1='58' y1='26' x2='58' y2='74' stroke='#fff' stroke-width='2'/></svg>`,
  ranger:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20 80 L50 15 L80 80 Z' fill='#e8ffe8' stroke='#2e5a2e' stroke-width='2'/><path d='M50 24 L60 55 L40 55 Z' fill='#2e5a2e'/></svg>`,
  stregone:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='18' fill='#fff'/><circle cx='50' cy='50' r='30' fill='none' stroke='#fff' stroke-width='4' stroke-dasharray='6 6'/></svg>`,
  warlock:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><polygon points='50,12 82,50 50,88 18,50' fill='#fff' stroke='#333' stroke-width='2'/><circle cx='50' cy='50' r='10' fill='#0f1115' /></svg>`,
  artificiere:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='34' cy='50' r='12' fill='#fff' stroke='#333' stroke-width='2'/><circle cx='66' cy='50' r='12' fill='#fff' stroke='#333' stroke-width='2'/><rect x='46' y='46' width='8' height='8' fill='#fff' stroke='#333' stroke-width='2'/></svg>`
};
function svgToImage(svgStr, cb){
  const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgStr);
  const img=new Image(); img.onload=()=>cb(img); img.src=url;
}

/* --------- Utility --------- */
function loadImage(file, cb){ if(!file) return cb(null); const img=new Image(); img.onload=()=>cb(img); img.src=URL.createObjectURL(file); }
function rr(ctx,x,y,w,h,r){r=Math.min(r,w/2,h/2);ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
function cover(ctx,img,dx,dy,dw,dh,r=0){
  const ir=img.width/img.height, dr=dw/dh; let sx,sy,sw,sh;
  if(ir>dr){ sh=img.height; sw=sh*dr; sx=(img.width-sw)/2; sy=0; }
  else{ sw=img.width; sh=sw/dr; sx=0; sy=(img.height-sh)/2; }
  if(r>0){ ctx.save(); rr(ctx,dx,dy,dw,dh,r); ctx.clip(); }
  ctx.drawImage(img,sx,sy,sw,sh,dx,dy,dw,dh);
  if(r>0) ctx.restore();
}
function gold(ctx){const g=ctx.createLinearGradient(0,0,0,30);g.addColorStop(0,'#fff7b3');g.addColorStop(.5,'#d3b25b');g.addColorStop(1,'#7a6223');return g;}
function silver(ctx){const g=ctx.createLinearGradient(0,0,0,30);g.addColorStop(0,'#ffffff');g.addColorStop(.5,'#cfd6e6');g.addColorStop(1,'#7f8aa3');return g;}
function drawTextWrap(ctx,text,x,y,maxW,lh){const w=(text||'').split(/\s+/);let line='',yy=y;for(let i=0;i<w.length;i++){const t=line+w[i]+' ';if(ctx.measureText(t).width>maxW&&i>0){ctx.fillText(line,x,yy);line=w[i]+' ';yy+=lh}else line=t}ctx.fillText(line,x,yy);}

/* --------- Font caricabili --------- */
async function loadCustomFont(file, familyName){
  const blobUrl = URL.createObjectURL(file);
  const face = new FontFace(familyName, `url(${blobUrl})`);
  await face.load();
  document.fonts.add(face);
  return familyName;
}

/* --------- Disegno fronte --------- */
const front=document.getElementById('cardFront'); const fctx=front.getContext('2d');

function defaultSymbolPos(){
  const W=750; const s=state.classSize; const right=W-44; const y=71 - s/2;
  state.classX = right - s; state.classY = y; // in alto a destra per default
}

function drawFront(){
  const W=750,H=1050; fctx.clearRect(0,0,W,H);

  // Cornice + interno con colori selezionati
  fctx.fillStyle=state.frameColor; rr(fctx,0,0,W,H,36); fctx.fill();
  fctx.fillStyle=state.innerColor; rr(fctx,16,16,W-32,H-32,24); fctx.fill();

  // Pannelli colorabili
  fctx.globalAlpha=state.panelAlpha;
  fctx.fillStyle=state.panelColor;
  rr(fctx,28,28,W-56,86,16); fctx.fill(); // barra titolo
  rr(fctx,28,610,W-56,412,18); fctx.fill(); // box descrizione
  fctx.globalAlpha=1;

  // Immagine centrale
  const ax=44, ay=132, aw=W-88, ah=460;
  if(state.imgFront) cover(fctx,state.imgFront,ax,ay,aw,ah,18);
  else { fctx.fillStyle='#cfcfcf'; rr(fctx,ax,ay,aw,ah,18); fctx.fill(); }

  // Titolo (a sinistra)
  const titleFamily = state.customTitleFontName ? `"${state.customTitleFontName}"` : state.titleFont;
  fctx.textBaseline='middle';
  fctx.font = `700 ${state.titleSize}px ${titleFamily}`;
  let tcol = (state.titleColor||'').toLowerCase();
  if(tcol==='gold') fctx.fillStyle=gold(fctx);
  else if(tcol==='silver') fctx.fillStyle=silver(fctx);
  else fctx.fillStyle=state.titleColor;
  fctx.fillText(state.title||'', 44, 71, 520);

  // Simbolo classe (se presente) — posizione da stato (drag), default in alto a destra
  let symbolWidth = 0;
  if(state.imgClass){
    if(state.classX==null || state.classY==null) defaultSymbolPos();
    const s = state.classSize;
    cover(fctx, state.imgClass, state.classX, state.classY, s, s, 8);
    symbolWidth = s + 10;
  }

  // Mana (opzionale) — se c'è simbolo, si sposta verso sinistra
  const mana=(state.mana||'').trim();
  if(mana){
    fctx.fillStyle='#222';
    fctx.font='600 22px Inter,sans-serif';
    fctx.textAlign='right';
    const rightEdge=W-44;
    const manaX = state.imgClass ? (rightEdge - symbolWidth) : rightEdge;
    fctx.fillText(mana, manaX, 71);
    fctx.textAlign='left';
  }

  // Descrizione (riquadro basso)
  const descFamily = state.customDescFontName ? `"${state.customDescFontName}"` : state.descFont;
  const bx=40, by=618, bw=W-80, bh=396;
  fctx.save(); rr(fctx,bx,by,bw,bh,18); fctx.clip();
  fctx.fillStyle=state.descColor; fctx.font=`400 ${state.descSize}px ${descFamily}`;
  drawTextWrap(fctx, state.descText||'', bx+18, by+18, bw-36, state.descSize*1.45);
  fctx.restore();
}

/* --------- Retro --------- */
function drawBackCanvas(){
  const c=document.createElement('canvas'); c.width=750; c.height=1050; const ctx=c.getContext('2d');
  rr(ctx,0,0,750,1050,36); ctx.fillStyle=state.frameColor; ctx.fill();
  rr(ctx,16,16,750-32,1050-32,24); ctx.fillStyle=state.innerColor; ctx.fill();
  if(state.imgBack) cover(ctx,state.imgBack,16,16,750-32,1050-32,24);
  return c;
}

/* --------- Bind UI --------- */
const $=id=>document.getElementById(id);
$('title').oninput=e=>{state.title=e.target.value;drawFront();}
$('mana').oninput=e=>{state.mana=e.target.value;drawFront();}

$('titleFont').onchange=e=>{state.customTitleFontName=null;state.titleFont=e.target.value;drawFront();}
$('titleSize').oninput=e=>{state.titleSize=+e.target.value;drawFront();}
$('titleColor').oninput=e=>{state.titleColor=e.target.value;drawFront();}
document.querySelectorAll('.preset').forEach(a=>a.addEventListener('click',e=>{e.preventDefault();state.titleColor=a.dataset.col;drawFront()}));

$('descFont').onchange=e=>{state.customDescFontName=null;state.descFont=e.target.value;drawFront();}
$('descSize').oninput=e=>{state.descSize=+e.target.value;drawFront();}
$('descColor').oninput=e=>{state.descColor=e.target.value;drawFront();}
$('rulesText').oninput=e=>{state.descText=e.target.value;drawFront();}

$('panelColor').oninput=e=>{state.panelColor=e.target.value;drawFront();}
$('panelAlpha').oninput=e=>{state.panelAlpha=+e.target.value/100;drawFront();}

$('frameColor').oninput=e=>{state.frameColor=e.target.value;drawFront();}
$('innerColor').oninput=e=>{state.innerColor=e.target.value;drawFront();}

/* Sorgente simbolo */
$('classSource').onchange=e=>{
  state.classSource=e.target.value;
  document.getElementById('dbRow').style.display = (state.classSource==='db')?'grid':'none';
  document.getElementById('uploadRow').style.display = (state.classSource==='upload')?'block':'none';
  if(state.classSource==='none'){ state.imgClass=null; }
  if(state.classSource==='db'){ loadDbIcon($('clazz').value); }
  if(state.classSource!=='upload'){ $('classImg').value=''; }
  drawFront();
};
$('clazz').onchange=e=>{ if(state.classSource==='db'){ loadDbIcon(e.target.value); } };
$('classSize').oninput=e=>{ state.classSize=+e.target.value; drawFront(); defaultSymbolPos(); };

/* Caricamento icona DB o upload */
function loadDbIcon(key){ const svg = ICONS[key]; if(!svg){state.imgClass=null;drawFront();return;} svgToImage(svg, img=>{ state.imgClass=img; if(state.classX==null||state.classY==null) defaultSymbolPos(); drawFront(); }); }
$('classImg').addEventListener('change',e=>{
  if(state.classSource!=='upload') return;
  loadImage(e.target.files?.[0], img=>{ state.imgClass=img; if(state.classX==null||state.classY==null) defaultSymbolPos(); drawFront(); });
});

/* Immagini fronte/retro */
$('artFront').addEventListener('change',e=>{loadImage(e.target.files?.[0], img=>{state.imgFront=img;drawFront();});});
$('artBack').addEventListener('change',e=>{loadImage(e.target.files?.[0], img=>{state.imgBack=img;});});

/* Font caricabili */
$('titleFontFile').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fam='UserTitleFont'; await loadCustomFont(f,fam); state.customTitleFontName=fam; drawFront();
});
$('descFontFile').addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const fam='UserDescFont'; await loadCustomFont(f,fam); state.customDescFontName=fam; drawFront();
});

/* Drag & Drop simbolo */
let dragging=false, dragOffX=0, dragOffY=0;
front.addEventListener('pointerdown',e=>{
  if(!state.imgClass) return;
  const rect=front.getBoundingClientRect();
  const scaleX=front.width/rect.width, scaleY=front.height/rect.height;
  const x=(e.clientX-rect.left)*scaleX, y=(e.clientY-rect.top)*scaleY;
  const s=state.classSize;
  if(x>=state.classX && x<=state.classX+s && y>=state.classY && y<=state.classY+s){
    dragging=true; dragOffX=x-state.classX; dragOffY=y-state.classY;
    front.setPointerCapture(e.pointerId);
  }
});
front.addEventListener('pointermove',e=>{
  if(!dragging) return;
  const rect=front.getBoundingClientRect();
  const scaleX=front.width/rect.width, scaleY=front.height/rect.height;
  let nx=(e.clientX-rect.left)*scaleX - dragOffX;
  let ny=(e.clientY-rect.top)*scaleY - dragOffY;
  // limiti al canvas
  const s=state.classSize;
  nx=Math.max(0,Math.min(front.width - s, nx));
  ny=Math.max(0,Math.min(front.height - s, ny));
  state.classX=nx; state.classY=ny; drawFront();
});
front.addEventListener('pointerup',e=>{ if(dragging){ dragging=false; front.releasePointerCapture(e.pointerId);} });
front.addEventListener('pointercancel',()=>dragging=false);

/* Welcome button */
document.getElementById('btnShowWelcome').onclick=()=>{
  localStorage.removeItem('cm_hide_welcome');
  document.getElementById('welcome').classList.remove('hide');
};

/* --------- Export --------- */
function downloadDataUrl(filename, dataUrl){ const a=document.createElement('a'); a.download=filename; a.href=dataUrl; a.click(); }
document.getElementById('pngFront').onclick=()=>{ drawFront(); downloadDataUrl('carta-front.png', front.toDataURL('image/png')); };
document.getElementById('pngBack').onclick=()=>{ const back=drawBackCanvas(); downloadDataUrl('carta-back.png', back.toDataURL('image/png')); };

document.getElementById('pdfSingleFront').onclick=()=>exportSingle(front,'carta-front.pdf');
document.getElementById('pdfSingleBack').onclick=()=>{ const back=drawBackCanvas(); exportSingle(back,'carta-back.pdf'); };

function exportSingle(canvasEl, name){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:[69,94]});
  const img=canvasEl.toDataURL('image/png'); doc.addImage(img,'PNG',0,0,69,94); doc.save(name);
}

document.getElementById('pdfA4Front').onclick=()=>exportA4Grid(front,'carte_3x3_fronti.pdf');
document.getElementById('pdfA4Back').onclick=()=>{ const back=drawBackCanvas(); exportA4Grid(back,'carte_3x3_retro.pdf'); };
document.getElementById('pdfA4Both').onclick=()=>exportA4Both();

function exportA4Grid(canvasEl, name){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W=210,H=297,cw=63,ch=88,marginX=7,marginY=7,gapX=(W-3*cw-2*marginX)/2,gapY=(H-3*ch-2*marginY)/2;
  const img=canvasEl.toDataURL('image/png');
  for(let r=0;r<3;r++) for(let c=0;c<3;c++){
    const x=marginX + c*(cw+gapX), y=marginY + r*(ch+gapY);
    doc.addImage(img,'PNG',x,y,cw,ch,undefined,'FAST');
  }
  doc.save(name);
}
function exportA4Both(){
  const {jsPDF}=window.jspdf; const doc=new jsPDF({unit:'mm',format:'a4',orientation:'portrait'});
  const W=210,H=297,cw=63,ch=88,marginX=7,marginY=7,gapX=(W-3*cw-2*marginX)/2,gapY=(H-3*ch-2*marginY)/2;

  drawFront();
  let img=front.toDataURL('image/png');
  for(let r=0;r<3;r++) for(let c=0;c<3;c++){
    const x=marginX + c*(cw+gapX), y=marginY + r*(ch+gapY);
    doc.addImage(img,'PNG',x,y,cw,ch,undefined,'FAST');
  }
  doc.addPage('a4','portrait');
  const back=drawBackCanvas(); img=back.toDataURL('image/png');
  for(let r=0;r<3;r++) for(let c=0;c<3;c++){
    const x=marginX + c*(cw+gapX), y=marginY + r*(ch+gapY);
    doc.addImage(img,'PNG',x,y,cw,ch,undefined,'FAST');
  }
  doc.save('carte_3x3_fronte+retro.pdf');
}

/* init */
(function init(){
  // carica icona DB iniziale
  svgToImage(ICONS[state.clazz], img=>{ state.imgClass=img; defaultSymbolPos(); drawFront(); });
})();
</script>

<script>
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }
</script>
</body>
</html>
